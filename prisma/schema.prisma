// prisma/schema.prisma
// TECHQUIZ AI MADAGASCAR 2025 — Version finale validée par Grok & Alex

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// UTILISATEUR
// ==========================================
model Utilisateur {
  id               Int       @id @default(autoincrement())
  nom              String
  prenom           String?
  sexe             Sexe      @default(HOMME)
  dateNaissance    DateTime?
  email            String    @unique
  motDePasse       String
  photoProfil      String?   @db.Text
  role             Role      @default(CLIENT)
  statut           String    @default("ACTIF") // ACTIF, EN_ATTENTE, BLOQUE
  niveau           Niveau    @default(DEBUTANT)
  noteMoyenne      Decimal   @default(0.00) @db.Decimal(5, 2)
  nombreEtoiles    Int       @default(0)
  dateInscription  DateTime  @default(now())
  derniereConnexion DateTime?

  // Relations
  quizCrees        Quiz[]
  tentatives       TentativeQuiz[]
  reponses         ReponseUtilisateur[]
  quizEpingles     QuizEpingles[]
  promptIAs        PromptIA[]

  @@map("utilisateurs")
}

// ==========================================
// CATÉGORIE
// ==========================================
model Categorie {
  id           Int      @id @default(autoincrement())
  nomCategorie String   @unique
  slug         String   @unique // pour URL propres : ex: "mathematiques"
  description  String?
  icone        String?  // emoji ou lien FontAwesome / SVG
  couleur      String?  // ex: #3B82F6
  dateCreation DateTime @default(now())

  quizzes      Quiz[]

  @@map("categories")
}

// =========================================== ================================
// QUIZ
// ==========================================
model Quiz {
  id                Int      @id @default(autoincrement())
  categorieId       Int
  createurId        Int
  titre             String
  slug              String   @unique // SEO + partage
  description       String?  @db.Text
  imageCouverture   String?  @db.Text
  typeQuestion      TypeQuestion[] // un quiz peut mélanger les types
  niveau            Niveau
  dureeMinutes      Int      @default(30)
  dureeSecondes     Int      @default(0)
  nombreQuestions   Int
  pointsTotaux      Int      @default(100)
  estPublic         Boolean  @default(true)
  estActif          Boolean  @default(true)
  modeCreation      ModeCreation @default(manuel)
  estGenereParIA    Boolean  @default(false)
  dateCreation      DateTime @default(now())
  dateModification  DateTime @updatedAt

  // Relations
  categorie         Categorie        @relation(fields: [categorieId], references: [id], onDelete: Restrict)
  createur          Utilisateur      @relation(fields: [createurId], references: [id], onDelete: Cascade)
  questions         Question[]
  tentatives        TentativeQuiz[]
  epingles          QuizEpingles[]
  statistiques      StatistiquesQuiz?

  @@index([categorieId])
  @@index([createurId])
  @@index([estPublic])
  @@map("quizzes")
}

// ==========================================
// QUESTION
// ==========================================
model Question {
  id              Int      @id @default(autoincrement())
  quizId          Int
  texteQuestion   String   @db.Text
  type            TypeQuestion
  imageQuestion   String?  @db.Text
  points          Int      @default(10)
  ordre           Int      @default(0)
  explication     String?  @db.Text
  estGenereeParIA Boolean  @default(false)
  dateCreation    DateTime @default(now())

  // Relations
  quiz            Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  choix           ChoixReponse[]
  reponses        ReponseUtilisateur[]

  @@index([quizId])
  @@map("questions")
}

// ==========================================
// CHOIX DE RÉPONSE (pour QCM)
// ==========================================
model ChoixReponse {
  id          Int      @id @default(autoincrement())
  questionId  Int
  texte       String
  estCorrect  Boolean  @default(false)
  ordre       Int      @default(0)

  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  reponses    ReponseUtilisateur[] // si l'utilisateur a choisi ce choix

  @@index([questionId])
  @@map("choix_reponses")
}

// ==========================================
// TENTATIVE DE QUIZ
// ==========================================
model TentativeQuiz {
  id                    Int      @id @default(autoincrement())
  quizId                Int
  utilisateurId         Int
  dateDebut             DateTime @default(now())
  dateFin               DateTime?
  tempsEcouleSecondes   Int      @default(0)
  scoreObtenu           Decimal? @db.Decimal(6, 2)
  pourcentage           Decimal? @db.Decimal(5, 2)
  nombreBonnesReponses  Int      @default(0)
  nombreQuestions       Int?
  estTermine            Boolean  @default(false)
  rang                  Int?     // position dans le classement du quiz

  // Relations
  quiz                  Quiz                 @relation(fields: [quizId], references: [id], onDelete: Cascade)
  utilisateur           Utilisateur          @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)
  reponses              ReponseUtilisateur[]

  @@index([quizId])
  @@index([utilisateurId])
  @@index([estTermine])
  @@map("tentatives_quiz")
}

// ==========================================
// RÉPONSE UTILISATEUR
// ==========================================
model ReponseUtilisateur {
  id                  Int      @id @default(autoincrement())
  tentativeId         Int
  questionId          Int
  choixId             Int?     // null si réponse libre
  utilisateurId       Int
  texteReponse        String?  @db.Text
  estCorrect         Boolean  @default(false)
  pointsObtenus       Int      @default(0)
  tempsReponseSecondes Int     @default(0)
  feedbackIA          String?  @db.Text
  dateReponse         DateTime @default(now())

  tentative           TentativeQuiz    @relation(fields: [tentativeId], references: [id], onDelete: Cascade)
  question            Question         @relation(fields: [questionId], references: [id], onDelete: Cascade)
  utilisateur         Utilisateur      @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)
  choix               ChoixReponse?    @relation(fields: [choixId], references: [id], onDelete: SetNull)

  @@index([tentativeId])
  @@index([questionId])
  @@map("reponses_utilisateur")
}

// ==========================================
// QUIZ ÉPINGLÉS (FAVORIS)
// ==========================================
model QuizEpingles {
  id             Int      @id @default(autoincrement())
  quizId         Int
  utilisateurId  Int
  dateEpingle    DateTime @default(now())

  quiz           Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  utilisateur    Utilisateur  @relation(fields: [utilisateurId], references: [id], onDelete: Cascade)

  @@unique([quizId, utilisateurId])
  @@map("quiz_epingles")
}

// ==========================================
// STATISTIQUES GLOBALES DU QUIZ
// ==========================================
model StatistiquesQuiz {
  id                  Int      @id @default(autoincrement())
  quizId              Int      @unique
  nombreTentatives    Int      @default(0)
  nombreTermines      Int      @default(0)
  nombreReussites     Int      @default(0) // ex: >70%
  noteMoyenne         Decimal  @default(0.00) @db.Decimal(5, 2)
  tempsMoyenSecondes  Int      @default(0)
  tauxReussite        Decimal  @default(0.00) @db.Decimal(5, 2)
  dateDerniereMaj     DateTime @updatedAt

  quiz                Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("statistiques_quiz")
}

// ==========================================
// PROMPT IA (historique des appels OpenAI)
// ==========================================
model PromptIA {
  id            Int      @id @default(autoincrement())
  utilisateurId Int?
  typeAction    String   // generer_quiz, evaluer_reponse, etc.
  prompt        String   @db.Text
  reponse       String   @db.Text
  model         String   @default("gpt-4o-mini")
  tokens        Int      @default(0)
  coutEstimate  Decimal  @default(0.00) @db.Decimal(8, 6)
  date          DateTime @default(now())

  utilisateur   Utilisateur? @relation(fields: [utilisateurId], references: [id])

  @@map("prompts_ia")
}

// ==========================================
// ENUMS
// ==========================================
enum Sexe {
  HOMME
  FEMME
  AUTRE
}

enum Role {
  ADMIN
  ENSEIGNANT
  ETUDIANT
  CLIENT
}

enum Niveau {
  DEBUTANT
  INTERMEDIAIRE
  AVANCE
  EXPERT
}

enum TypeQuestion {
  QCM
  VRAI_FAUX
  REPONSE_COURTE
  REPONSE_LONGUE
}

enum ModeCreation {
  manuel
  ia
}